---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import BlogLayout from '../../components/blog/BlogLayout.astro';
import Button from '../../components/shared/ui/Button.astro';
import PostNavigation from '../../components/blog/PostNavigation.astro';
import { getRelativeTime, getFormattedDate } from '../../utils/date';

export async function getStaticPaths() {
	// Get all published posts sorted by date (newest first)
	const allPosts = await getCollection('blog', (entry) => {
		return entry.data.draft !== true;
	});
	const sortedPosts = allPosts.sort((a, b) => 
		b.data.pubDate.getTime() - a.data.pubDate.getTime()
	);

	return sortedPosts.map((post, index) => {
		// Previous post is newer (index - 1), next post is older (index + 1)
		const prevPost = index > 0 ? sortedPosts[index - 1] : undefined;
		const nextPost = index < sortedPosts.length - 1 ? sortedPosts[index + 1] : undefined;

		return {
			params: { slug: post.slug },
			props: { post, prevPost, nextPost },
		};
	});
}

interface Props {
	post: CollectionEntry<'blog'>;
	prevPost?: CollectionEntry<'blog'>;
	nextPost?: CollectionEntry<'blog'>;
}

const { post, prevPost, nextPost } = Astro.props;
const { Content } = await post.render();

const formattedDate = getFormattedDate(post.data.pubDate);
const relativeTime = getRelativeTime(post.data.pubDate);
const formattedUpdatedDate = post.data.updatedDate ? getFormattedDate(post.data.updatedDate) : undefined;

// Get image URL
const imageUrl = post.data.image 
	? (typeof post.data.image.url === 'string' ? post.data.image.url : post.data.image.url.src)
	: undefined;

// Structured data for blog post
const structuredData = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	"headline": post.data.title,
	"description": post.data.description,
	"image": imageUrl,
	"datePublished": post.data.pubDate.toISOString(),
	"dateModified": post.data.updatedDate?.toISOString() || post.data.pubDate.toISOString(),
	"author": {
		"@type": "Person",
		"name": post.data.author,
		"jobTitle": "Psychological Counsellor",
		"url": Astro.site
	},
	"publisher": {
		"@type": "Organization",
		"name": "Marsam Therapy",
		"logo": {
			"@type": "ImageObject",
			"url": new URL('/logo.png', Astro.site).toString()
		}
	},
	"mainEntityOfPage": {
		"@type": "WebPage",
		"@id": new URL(Astro.url.pathname, Astro.site).toString()
	},
	"keywords": post.data.tags.join(', ')
};
---

<Layout 
	title={post.data.title} 
	description={post.data.description}
	image={imageUrl}
	article={true}
	publishedTime={post.data.pubDate.toISOString()}
	modifiedTime={post.data.updatedDate?.toISOString()}
	author={post.data.author}
	keywords={post.data.tags}
>
	<Fragment slot="head">
		<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
	</Fragment>
	<article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16 sm:py-24">
		<!-- Article Header -->
		<header class="mb-12">
			<!-- Tags first (small and subtle) -->
			{post.data.tags.length > 0 && (
				<div class="flex flex-wrap gap-2 mb-6">
					{post.data.tags.map((tag) => (
						<span class="px-2.5 py-1 text-xs uppercase tracking-wider font-medium text-primary/80 bg-primary/5 border border-primary/20 rounded">
							{tag.replace(/-/g, ' ')}
						</span>
					))}
				</div>
			)}
			
			<!-- Title (hero) -->
			<h1 class="font-serif text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-ivory leading-[1.1] mb-6">
				{post.data.title}
			</h1>
			
			<!-- Description -->
			<p class="text-charcoal text-lg sm:text-xl leading-relaxed mb-8">
				{post.data.description}
			</p>
			
			<!-- Author & Date (clean and minimal) -->
			<div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 pt-6 border-t border-night-lighter">
				<div class="flex items-center gap-3">
					<div class="w-10 h-10 rounded-full bg-primary/20 border border-primary/30 flex items-center justify-center">
						<span class="text-primary font-semibold text-sm">MS</span>
					</div>
					<div>
						<p class="text-ivory text-sm font-medium">{post.data.author}</p>
						<p class="text-charcoal-light text-xs">Psychological Counsellor</p>
					</div>
				</div>
				<div class="flex items-center gap-4 text-sm text-charcoal-light sm:ml-auto">
					<time datetime={post.data.pubDate.toISOString()} class="flex items-center gap-1.5" title={formattedDate}>
						<svg class="w-4 h-4 text-primary/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						<span>{relativeTime}</span>
					</time>
					{formattedUpdatedDate && (
						<span class="text-xs text-charcoal-dark" title={`Updated on ${formattedUpdatedDate}`}>
							Updated
						</span>
					)}
				</div>
			</div>
		</header>

		<!-- Featured Image -->
		{post.data.image && (
			<div class="mb-12 rounded-xl overflow-hidden shadow-2xl">
				<img
					src={typeof post.data.image.url === 'string' ? post.data.image.url : post.data.image.url.src}
					alt={post.data.image.alt}
					class="w-full h-auto"
					loading="eager"
				/>
			</div>
		)}

		<!-- Article Content -->
		<BlogLayout>
			<Content />
		</BlogLayout>

		<!-- Previous/Next Navigation -->
		<PostNavigation prevPost={prevPost} nextPost={nextPost} />

		<!-- Article Footer -->
		<footer class="mt-12 pt-8 border-t border-night-lighter">
			<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6">
				<!-- Author Card -->
				<div class="flex items-center gap-4">
					<div class="w-12 h-12 rounded-full bg-primary/20 border border-primary/30 flex items-center justify-center flex-shrink-0">
						<span class="text-primary font-semibold">MS</span>
					</div>
					<div>
						<p class="text-ivory font-medium">{post.data.author}</p>
						<p class="text-charcoal-light text-sm">Psychological Counsellor</p>
					</div>
				</div>
				
				<!-- Back Button -->
				<Button href="/blog" variant="outline" size="md">
					← Back to Blog
				</Button>
			</div>
		</footer>

		<!-- CTA Section -->
		<div class="mt-12 p-8 sm:p-10 bg-night-light border border-night-lighter rounded-xl text-center">
			<span class="text-3xl text-primary mb-4 block">✦</span>
			<h3 class="font-serif text-2xl sm:text-3xl text-ivory mb-3">
				Start Your Healing Journey
			</h3>
			<p class="text-charcoal-light text-sm sm:text-base mb-8 max-w-xl mx-auto leading-relaxed">
				If this resonates with you and you're ready to explore therapy, 
				I'd be honored to support you on your path to wellness.
			</p>
			<Button href="/#contact" variant="primary" size="lg">
				Book a Consultation
			</Button>
		</div>
	</article>
</Layout>
